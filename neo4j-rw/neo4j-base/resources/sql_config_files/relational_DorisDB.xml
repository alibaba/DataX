<?xml version="1.0" encoding="utf-8"?>

<sql>

    <getTables type="NODE" workName="同步表" seq="1" nodeName="表" label="resource.relational.tableEntity" columns="moiName,comment,moiCreateDate,moiUpdateDate,owner,isTemporary,guid">
        <![CDATA[
			SELECT
                DISTINCT t.table_name AS moiName,
                t.table_comment AS comment,
                DATE_FORMAT(t.CREATE_TIME,'%Y%m%d%H%i%s') AS moiCreateDate,
                DATE_FORMAT(t.UPDATE_TIME,'%Y%m%d%H%i%s') AS moiUpdateDate,
                t.TABLE_SCHEMA as owner,
                case when lower('${param.schema}') = 'temp' then 'true' else 'false' end as isTemporary,
                CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.TABLE_NAME) as guid
            FROM information_schema.TABLES t
                WHERE t.table_schema = '${param.schema}'
            AND t.table_type = 'BASE TABLE'
                ORDER BY moiName ASC
		]]>
    </getTables>


    <getTableColumn type="NODE" workName="同步表字段" seq="2" nodeName="表字段" label="resource.relational.columnEntity" sourceLabel="resource.relational.tableEntity" columns="moiCreateDate,moiUpdateDate,moiName,columnId,moiSeq,initialValue,isNullable,sqlSimpleType,length,precision,scale,comment,characterSetName,guid">
        <![CDATA[
           SELECT
                DATE_FORMAT(t.CREATE_TIME,'%Y%m%d%H%i%s') AS moiCreateDate,
                DATE_FORMAT(t.UPDATE_TIME,'%Y%m%d%H%i%s') AS moiUpdateDate,
                c.column_name AS moiName,
                c.ordinal_position AS columnId,
                c.ordinal_position AS moiSeq,
                c.column_default AS initialValue,
                c.is_nullable AS isNullable,
                c.data_type AS sqlSimpleType,
                c.character_maximum_length AS length,
                c.numeric_precision AS `precision`,
                c.numeric_scale AS scale,
                c.column_comment AS `comment`,
                c.CHARACTER_SET_NAME AS characterSetName,
                CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name,';',c.column_name) as guid
            FROM
                (
                    SELECT
                        table_comment,
                        table_schema,
                        table_name,
                        table_type,
                        CREATE_TIME,
                        UPDATE_TIME,
                        TABLE_ROWS,
                        DATA_LENGTH
                    FROM
                        information_schema. TABLES
                    WHERE
                        table_schema = '${param.schema}'
                    AND table_type = 'BASE TABLE'
                ) t,
                information_schema.COLUMNS c
            WHERE
                 t.table_schema = c.table_schema
            AND  t.table_name = c.table_name
            order by t.table_name,c.ordinal_position asc
		]]>
    </getTableColumn>

    <getView type="NODE" workName="同步表视图" seq="3" nodeName="视图" label="resource.relational.viewEntity" columns="moiName,guid,sql,creator">
        SELECT
            v.TABLE_NAME as moiName,
            CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',v.TABLE_SCHEMA,';',v.TABLE_SCHEMA,';',v.TABLE_NAME) as guid,
            v.VIEW_DEFINITION as `sql`,
            v.`DEFINER` as creator
        FROM
            information_schema.VIEWS v
        WHERE
            v.TABLE_SCHEMA = '${param.schema}' ORDER BY v.TABLE_NAME ASC
    </getView>

    <getSQLIndexes type="NODE" workName="同步表索引" seq="4" nodeName="索引" label="resource.relational.sQLIndexEntity" columns="moiName,guid,method,type">
        <![CDATA[
	        select
	                distinct CONCAT(index_name,'_',TABLE_NAME) as moiName,
                    CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',table_schema,';',table_schema,';',index_name,'_',table_name) as guid,
                    index_type as method,
                    case when
                        NON_UNIQUE = 0 and INDEX_NAME != 'PRIMARY' then 'unique'
                    when
                        NON_UNIQUE = 0 and INDEX_NAME = 'PRIMARY' then 'primary'
                    when
                        NON_UNIQUE = 1 and INDEX_NAME != 'PRIMARY' then 'normal'
                    else 'fulltext'
                    end as type
               from information_schema.statistics s
            where s.index_schema = '${param.schema}' order by CONCAT(index_name,'_',TABLE_NAME) asc
	    ]]>
    </getSQLIndexes>

    <getViewColumn type="NODE" workName="同步视图字段" seq="5" nodeName="视图字段" label="resource.relational.columnEntity" sourceLabel="resource.relational.viewEntity"  columns="moiName,columnId,moiSeq,initialValue,isNullable,sqlSimpleType,length,precision,scale,comment,characterSetName,guid">
        select
        c.column_name as moiName,
        c.ordinal_position as columnId,
        c.ordinal_position as moiSeq,
        c.column_default as initialValue,
        c.is_nullable as isNullable,
        c.data_type as sqlSimpleType,
        c.character_maximum_length as length,
        c.numeric_precision as `precision`,
        c.numeric_scale as scale,
        c.column_comment as `comment`,
        c.CHARACTER_SET_NAME as characterSetName,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name,';',c.column_name) as guid
        from information_schema.TABLES t
        left join information_schema.VIEWS v
        on(t.table_schema = v.table_schema and t.table_name = v.table_name)
        left join information_schema.COLUMNS c
        on(v.table_schema = c.table_schema and v.table_name = c.table_name)
        where t.table_schema = '${param.schema}' and t.table_type = 'VIEW'
        order by columnId asc
    </getViewColumn>




    <getSchemasToView type="RELATIONSHIP" workName="同步Schema->视图的关系" seq="6" label="resource.relational.schemaToViewEntity" srcLabel="resource.relational.schemaEntity" targetLabel="resource.relational.viewEntity">
        SELECT
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name) as targetGuid
        FROM
        information_schema.VIEWS t
        WHERE
        t.TABLE_SCHEMA = '${param.schema}'
    </getSchemasToView>

    <getViewToColumn type="RELATIONSHIP" workName="同步视图->视图字段的关系" seq="7" label="resource.relational.viewToColumnEntity" srcLabel="resource.relational.viewEntity" targetLabel="resource.relational.columnEntity">
        select
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name,';',c.column_name) as targetGuid
        from information_schema.TABLES t
        left join information_schema.VIEWS v
        on(t.table_schema = v.table_schema and t.table_name = v.table_name)
        left join information_schema.COLUMNS c
        on(v.table_schema = c.table_schema and v.table_name = c.table_name)
        where t.table_schema = '${param.schema}' and t.table_type = 'VIEW'
        order by c.ordinal_position asc
    </getViewToColumn>



    <getSchemasToTable type="RELATIONSHIP" workName="同步Schema->表的关系" seq="8"  label="resource.relational.schemaToTableEntity" srcLabel="resource.relational.schemaEntity" targetLabel="resource.relational.tableEntity" >
        SELECT
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',TABLE_SCHEMA,';',TABLE_SCHEMA) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',TABLE_SCHEMA,';',TABLE_SCHEMA,';',table_name) as targetGuid
        FROM
        information_schema.`TABLES`
        where TABLE_SCHEMA = '${param.schema}'
        and TABLE_TYPE = 'BASE TABLE'
    </getSchemasToTable>

    <getTableToColumn type="RELATIONSHIP" workName="同步表->字段的关系" seq="9" label="resource.relational.tableToColumnEntity" srcLabel="resource.relational.tableEntity" targetLabel="resource.relational.columnEntity" >
        SELECT
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',t.TABLE_SCHEMA,';',t.TABLE_SCHEMA,';',t.table_name,';',c.column_name) as targetGuid
        FROM
        (
        SELECT
        table_comment,
        table_schema,
        table_name,
        table_type,
        CREATE_TIME,
        UPDATE_TIME,
        TABLE_ROWS,
        DATA_LENGTH
        FROM
        information_schema. TABLES
        WHERE
        table_schema = '${param.schema}'
        AND table_type = 'BASE TABLE'
        ) t,
        information_schema. COLUMNS c
        WHERE
         t.table_schema = c.table_schema
        AND  t.table_name = c.table_name
        order by t.table_name,c.ordinal_position asc
    </getTableToColumn>


    <getSchemasToSqlIndex type="RELATIONSHIP" workName="同步Schema->索引的关系" seq="10" label="resource.relational.schemaToSQLIndexEntity" srcLabel="resource.relational.schemaEntity" targetLabel="resource.relational.sQLIndexEntity">
        select
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',table_schema,';',table_schema) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',table_schema,';',table_schema,';',index_name,'_',table_name) as targetGuid
        from information_schema.statistics
        where index_schema = '${param.schema}'
    </getSchemasToSqlIndex>

    <getSqlIndexToColumn type="RELATIONSHIP" workName="同步索引->字段的关系" seq="11" label="resource.relational.sQLIndexToColumnEntity" srcLabel="resource.relational.sQLIndexEntity" targetLabel="resource.relational.columnEntity">
        select
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',table_schema,';',table_schema,';',index_name,'_',table_name) as sourceGuid,
        CONCAT('${param.systemId}',';','${param.env}',';','数据字典',';',table_schema,';',table_schema,';',table_name,';',column_name) as targetGuid
        from information_schema.statistics
        where index_schema = '${param.schema}'
    </getSqlIndexToColumn>

</sql>
